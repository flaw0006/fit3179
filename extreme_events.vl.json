{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "description": "Extreme weather events per year with interactive filtering and spike annotations.",
  "width": "container",
  "height": 450,

  "data": { "url": "Extreme_Event_Data/Extreme_Weather_Events_By_Year.csv" },

  "params": [
    {
      "name": "typePick",
      "value": [],
      "bind": {
        "input": "select",
        "multiple": true,
        "size": 8,
        "options": [
          "Bushfire",
          "Cyclone",
          "Earthquake",
          "Environment/Heatwave",
          "Flood",
          "Landslide",
          "Storm",
          "Tsunami"
        ],
        "labels": [
          "Bushfire",
          "Cyclone",
          "Earthquake",
          "Heatwave",
          "Flood",
          "Landslide",
          "Storm",
          "Tsunami"
        ],
        "name": "Filter by event type:"
      }
    }
  ],

  "transform": [
    {
      "filter": "length(typePick)==0 || indexof(typePick, datum.event_type) >= 0"
    }
  ],

  "layer": [
    {
      "mark": {
        "type": "bar",
        "tooltip": true,
        "cornerRadiusTopLeft": 2,
        "cornerRadiusTopRight": 2
      },
      "encoding": {
        "x": {
          "field": "year",
          "type": "ordinal",
          "title": "Year",
          "axis": {
            "labelAngle": -45,
            "labelFontSize": 12,
            "titleFontSize": 14
          }
        },
        "y": {
          "aggregate": "sum",
          "field": "count",
          "type": "quantitative",
          "title": "Number of Events",
          "axis": {
            "titleFontSize": 14,
            "labelFontSize": 12
          }
        },
        "color": {
          "field": "event_type",
          "type": "nominal",
          "title": "Event Type",
          "scale": {
            "scheme": "tableau10"
          }
        },
        "tooltip": [
          {"field": "year", "title": "Year"},
          {"field": "event_type", "title": "Type"},
          {"aggregate": "sum", "field": "count", "title": "Total Events"}
        ]
      }
    },

    {
      "transform": [
        {
          "aggregate": [{"op": "sum", "field": "count", "as": "total"}],
          "groupby": ["year"]
        },
        {
          "window": [{"op": "rank", "as": "rk"}],
          "sort": [{"field": "total", "order": "descending"}]
        },
        {
          "filter": "datum.rk <= 6"
        }
      ],
      "mark": {
        "type": "text",
        "dy": -8,
        "fontWeight": "bold",
        "fontSize": 12
      },
      "encoding": {
        "x": {"field": "year", "type": "ordinal"},
        "y": {"field": "total", "type": "quantitative"},
        "text": {"field": "year"},
        "color": {"value": "#333"}
      }
    }
  ],

  "config": {
    "legend": {
      "orient": "bottom",
      "labelFontSize": 12,
      "titleFontSize": 14
    },
    "axis": {
      "grid": false,
      "domainColor": "#ccc",
      "tickColor": "#ccc",
      "labelColor": "#333",
      "titleColor": "#333"
    },
    "view": {"stroke": null},
    "background": "white"
  }
}
